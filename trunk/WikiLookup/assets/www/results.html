<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
	<title>Kết quả tìm kiếm</title>
	
	<!-- Wikilookup references -->
	<link rel="stylesheet" type="text/css" href="css/googlemap.css" />
	<script src="https://maps.googleapis.com/maps/api/js?sensor=false&language=vi&libraries=places"></script>
	
	<script>
		var map, placesList;
		function initialize() {
			// Lấy dữ liệu chuyển đổi kinh, vĩ độ, khóa kiếm
			var mySearch = location.search.substr(1);
			var x = mySearch.toString().indexOf('@');
			var y = mySearch.toString().indexOf('$');
			var lat = mySearch.toString().substr(0, x);
			var lon = mySearch.toString().substr(x + 1, y - x - 1);
			var key = mySearch.toString().substr(y + 1);
			for(i=0;i<key.length;i++){key = key.replace('%20',' ');}
			
			// Vị trí hiển thị khi bản đồ hiển thị lần đầu tiên Vị trí hiện tại của điện thoại
			var pyrmont = new google.maps.LatLng(lat,lon);
			
			// Khởi tạo bản đồ
			map = new google.maps.Map(document.getElementById('map_canvas'), {
				mapTypeId : google.maps.MapTypeId.ROADMAP,
				center : pyrmont,
				zoom : 17
			});

			// Khởi tạo đối tượng request với từ khóa tìm kiếm
			var request = {query : key};
			
			// Hiển thị các địa điểm tìm được lên list có ul#places
			placesList = document.getElementById('places');
			
			// request đến service
			var service = new google.maps.places.PlacesService(map);
		
			// Gọi hàm callback trả kết quả về
			service.textSearch(request, callback); // đổi hàm sử dụng API Google Place text search
		}

		function callback(results, status, pagination) {
			if (status != google.maps.places.PlacesServiceStatus.OK) {return;}
			else {
				// Nếu có kết quả thì thực hiện gắn các nhãn lên bản đồ
				createMarkers(results);

				// google hỗ trợ phân trang nếu quá nhiều địa điểm trong kết quả
				if (pagination.hasNextPage) {
					var moreButton = document.getElementById('more');
					moreButton.disabled = false;
					google.maps.event.addDomListenerOnce(moreButton, 'click', function() {
						moreButton.disabled = true;
						pagination.nextPage();
					});
				}
			}
		}

		// Hàm gắn các nhãn dựa vào đối tượng place
		function createMarkers(places) {
			var bounds = new google.maps.LatLngBounds();

			for ( var i = 0, place; place = places[i]; i++) {
				var image = new google.maps.MarkerImage(place.icon,
						new google.maps.Size(71, 71), new google.maps.Point(0,
								0), new google.maps.Point(17, 34),
						new google.maps.Size(25, 25));

				var marker = new google.maps.Marker({
					map : map,
					icon : image,
					title : place.name,
					position : place.geometry.location
				});

				placesList.innerHTML += '<li>' + place.name + '</li>';

				bounds.extend(place.geometry.location);
			}
			map.fitBounds(bounds);
		}

		google.maps.event.addDomListener(window, 'load', initialize);
	</script>
</head>
<body>
<div id="map_canvas"></div>
<div id="results">
<h2>Results</h2>
<ul id="places"></ul>
<button id="more">More results</button>
</div>
</body>
</html>